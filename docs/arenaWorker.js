import{C as h,V as d,U as c}from"./chunks/Utils-YcxBL4lD.js";class E{constructor(t,s,i){this.field=t,this.id=-1,this.direction=0,this.size=h.COLLISION_SIZE,this.wait=0,this.wait=0,this.position=new d(s,i),this.speed=new d(0,0)}think(){this.wait<=0?(this.wait=0,this.onThink()):this.wait=this.wait-1}onThink(){}action(){}move(){this.position=this.position.add(this.speed)}onHit(t){}dump(){throw new Error("not implimentation")}}class D{constructor(){this.isAccepted=!1}validate(){if(!this.isAccepted)throw new Error("Invalid command.")}accept(){this.isAccepted=!0}unaccept(){this.isAccepted=!1}}class A extends D{constructor(t){super(),this.sourcer=t,this.ahead=0,this.ascent=0,this.turn=!1,this.fire=null,this.reset()}reset(){this.ahead=0,this.ascent=0,this.turn=!1,this.fire=null}execute(){this.fire&&this.sourcer.fire(this.fire),this.turn&&(this.sourcer.direction*=-1),0<this.sourcer.fuel&&(this.sourcer.speed=this.sourcer.speed.add(this.ahead*this.sourcer.direction,this.ascent),this.sourcer.fuel-=(Math.abs(this.ahead)+Math.abs(this.ascent))*h.FUEL_COST,this.sourcer.fuel=Math.max(0,this.sourcer.fuel))}}class w{constructor(t){this.framesOfLife=0,this.preThink=()=>{this.framesOfLife++},this.frame=()=>this.framesOfLife,this.altitude=()=>t.position.y,this.wait=s=>{0<s&&(t.wait+=s)}}}class I{constructor(t){this.shotType=t}isLaser(){return this.shotType==="Laser"}isMissile(){return this.shotType==="Missile"}}class x extends I{constructor(t){super("Missile"),this.bot=t}}class S extends I{constructor(t,s){super("Laser"),this.direction=s,this.power=0,this.power=Math.min(Math.max(t||8,3),8)}}class y extends w{constructor(t){super(t),this.shield=()=>t.shield,this.temperature=()=>t.temperature,this.missileAmmo=()=>t.missileAmmo,this.fuel=()=>t.fuel;const s=t.field,i=t.command;this.scanEnemy=(n,o,r)=>{i.validate(),t.wait+=h.SCAN_WAIT;const l=t.opposite(n),p=r||Number.MAX_VALUE,f=c.createRadar(t.position,l,o,p);return s.scanEnemy(t,f)},this.scanAttack=(n,o,r)=>{i.validate(),t.wait+=h.SCAN_WAIT;const l=t.opposite(n),p=r||Number.MAX_VALUE,f=c.createRadar(t.position,l,o,p);return s.scanAttack(t,f)},this.ahead=()=>{i.validate(),i.ahead=.8},this.back=()=>{i.validate(),i.ahead=-.4},this.ascent=()=>{i.validate(),i.ascent=.9},this.descent=()=>{i.validate(),i.ascent=-.9},this.turn=()=>{i.validate(),i.turn=!0},this.fireLaser=(n,o)=>{i.validate(),i.fire=new S(o,n)},this.fireMissile=n=>{i.validate(),i.fire=new x(n)};const e=n=>Object.prototype.toString.call(n)==="[object String]";this.log=(...n)=>{i.validate(),t.log(n.map(o=>e(o)?o:JSON.stringify(o)).join(", "))},this.scanDebug=(n,o,r)=>{i.validate(),t.scanDebug(t.opposite(n),o,r)}}connectConsole(t){t&&(t.log=this.log.bind(this))}}const u=class u{};u.DIRECTION_RIGHT=1,u.DIRECTION_LEFT=-1,u.VERTICAL_UP="vertial_up",u.VERTICAL_DOWN="vertial_down";let m=u;class b{constructor(t,s,i,e){this.field=t,this.position=s,this.speed=i,this.length=e,this.id=-1,this.frame=0}action(){this.frame++,this.length<=this.frame&&this.field.removeFx(this)}move(){this.position=this.position.add(this.speed)}dump(){return{i:this.id,p:this.position.minimize(),f:this.frame,l:Math.round(this.length)}}}class T extends E{constructor(t,s,i){super(t,s.position.x,s.position.y),this.owner=s,this.type=i,this.temperature=0,this.damage=()=>0,this.breakable=!1}action(){this.onAction();const t=this.field.checkCollision(this);t&&(t.onHit(this),this.createFxs()),this.field.checkCollisionEnviroment(this)&&(this.field.removeShot(this),this.createFxs())}createFxs(){for(let t=0;t<3;t++){const s=this.position.add(c.rand(16)-8,c.rand(16)-8),i=new d(c.rand(1)-.5,c.rand(1)-.5),e=c.rand(8)+4;this.field.addFx(new b(this.field,s,this.speed.divide(2).add(i),e))}}reaction(t){t.temperature+=this.temperature}onAction(){}dump(){return{o:this.owner.id,i:this.id,p:this.position.minimize(),d:this.direction,s:this.type}}}class N extends T{constructor(t,s,i,e){super(t,s,"Laser"),this.direction=i,this.temperature=5,this.damage=()=>8,this.speed=d.direction(i).multiply(e),this.momentum=h.LASER_MOMENTUM}action(){super.action(),this.momentum-=h.LASER_ATTENUATION,this.momentum<0&&this.field.removeShot(this)}}class L extends D{constructor(t){super(),this.missile=t,this.speedUp=0,this.speedDown=0,this.turn=0,this.reset()}reset(){this.speedUp=0,this.speedDown=0,this.turn=0}execute(){if(0<this.missile.fuel){this.missile.direction+=this.turn;const t=d.direction(this.missile.direction);this.missile.speed=this.missile.speed.add(t.multiply(this.speedUp)),this.missile.speed=this.missile.speed.multiply(1-this.speedDown),this.missile.fuel-=(this.speedUp+this.speedDown*3)*h.FUEL_COST,this.missile.fuel=Math.max(0,this.missile.fuel)}}}class M extends w{constructor(t){super(t),this.direction=()=>t.direction;const s=t.command;this.fuel=()=>t.fuel,this.scanEnemy=(e,n,o)=>{s.validate(),t.wait+=1.5;const r=t.opposite(e),l=c.createRadar(t.position,r,n,o||Number.MAX_VALUE);return t.field.scanEnemy(t.owner,l)},this.speedUp=()=>{s.validate(),s.speedUp=.8},this.speedDown=()=>{s.validate(),s.speedDown=.1},this.turnRight=()=>{s.validate(),s.turn=-9},this.turnLeft=()=>{s.validate(),s.turn=9};const i=e=>Object.prototype.toString.call(e)==="[object String]";this.log=(...e)=>{s.validate(),t.log(e.map(n=>i(n)?n:JSON.stringify(n)).join(", "))},this.scanDebug=(e,n,o)=>{s.validate(),t.scanDebug(t.opposite(e),n,o)}}connectConsole(t){t&&(t.log=this.log.bind(this))}}class v extends T{constructor(t,s,i){super(t,s,"Missile"),this.bot=i,this.temperature=10,this.damage=()=>10+this.speed.length()*2,this.fuel=100,this.breakable=!0,this.debugDump={logs:[],arcs:[]},this.direction=s.direction===m.DIRECTION_RIGHT?0:180,this.speed=s.speed,this.command=new L(this),this.command.reset(),this.controller=new M(this)}onThink(){if(this.command.reset(),!(this.fuel<=0))try{this.command.accept(),this.controller.preThink(),this.debugDump={logs:[],arcs:[]},this.owner.scriptLoader&&this.controller.connectConsole(this.owner.scriptLoader.getExposedConsole()),this.bot(this.controller)}catch(t){this.command.reset();const s=t instanceof Error?t.message:String(t);this.debugDump.logs.push({message:`Missile function error: ${s}`,color:"red"})}finally{this.command.unaccept()}}onAction(){this.speed=this.speed.multiply(h.SPEED_RESISTANCE),this.command.execute(),this.command.reset()}onHit(t){this.field.removeShot(this),this.field.removeShot(t)}opposite(t){return this.direction+t}log(t){this.debugDump.logs.push({message:t})}scanDebug(t,s,i){this.debugDump.arcs.push({direction:t,angle:s,renge:i})}dump(){const t=super.dump();return this.owner.scriptLoader&&this.owner.scriptLoader.isDebuggable()&&(t.debug=this.debugDump),t}}class O extends E{constructor(t,s,i,e,n,o,r){super(t,s,i),this.aiSource=e,this.account=n,this.name=o,this.color=r,this.alive=!0,this.temperature=0,this.shield=h.INITIAL_SHIELD,this.missileAmmo=h.INITIAL_MISSILE_AMMO,this.fuel=h.INITIAL_FUEL,this.bot=null,this.debugDump={logs:[],arcs:[]},this.direction=Math.random()<.5?m.DIRECTION_RIGHT:m.DIRECTION_LEFT,this.command=new A(this),this.controller=new y(this)}compile(t){if(this.scriptLoader=t,this.bot=t.load(this.aiSource),!this.bot)throw{message:"Function has not been returned."};if(typeof this.bot!="function")throw{message:"Returned is not a Function."}}onThink(){if(!(this.bot===null||!this.alive))try{this.command.accept(),this.controller.preThink(),this.debugDump={logs:[],arcs:[]},this.scriptLoader&&this.controller.connectConsole(this.scriptLoader.getExposedConsole()),this.bot(this.controller)}catch(t){const s=t instanceof Error?t.message:String(t);this.debugDump.logs.push({message:`Sourcer function error: ${s}`,color:"red"}),this.command.reset()}finally{this.command.unaccept()}}action(){if(!this.alive&&c.rand(8)<1){const i=this.position.add(c.rand(16)-8,c.rand(16)-8),e=new d(c.rand(1)-.5,c.rand(1)+.5),n=c.rand(8)+4;this.field.addFx(new b(this.field,i,e,n))}if(this.speed=this.speed.multiply(h.SPEED_RESISTANCE),this.speed=this.speed.subtract(0,h.GRAVITY),h.TOP_INVISIBLE_HAND<this.position.y){const i=(this.position.y-h.TOP_INVISIBLE_HAND)*.1;this.speed=this.speed.subtract(0,h.GRAVITY*i)}const t=this.field.center-this.position.x;if(h.DISTANCE_BORDAR<Math.abs(t)){const i=t<0?-1:1,e=(Math.abs(t)-h.DISTANCE_BORDAR)*h.DISTANCE_INVISIBLE_HAND*i;this.position=new d(this.position.x+e,this.position.y)}this.position.y<0&&(this.shield-=-this.speed.y*h.GROUND_DAMAGE_SCALE,this.position=new d(this.position.x,0),this.speed=new d(this.speed.x,0)),this.temperature-=h.COOL_DOWN,this.temperature=Math.max(this.temperature,0);const s=this.temperature-h.OVERHEAT_BORDER;if(0<s){const i=s*h.OVERHEAT_DAMAGE_LINEAR_WEIGHT,e=Math.pow(s*h.OVERHEAT_DAMAGE_POWER_WEIGHT,2);this.shield-=i+e}this.shield=Math.max(0,this.shield),this.command.execute(),this.command.reset()}fire(t){if(t.isLaser()){const s=this.opposite(t.direction),i=new N(this.field,this,s,t.power);i.reaction(this),this.field.addShot(i)}if(t.isMissile()&&0<this.missileAmmo){const s=new v(this.field,this,t.bot);s.reaction(this),this.missileAmmo--,this.field.addShot(s)}}opposite(t){return this.direction===m.DIRECTION_LEFT?c.toOpposite(t):t}onHit(t){this.speed=this.speed.add(t.speed.multiply(h.ON_HIT_SPEED_GIVEN_RATE)),this.shield-=t.damage(),this.shield=Math.max(0,this.shield),this.field.removeShot(t)}log(t){this.debugDump.logs.push({message:t})}scanDebug(t,s,i){this.debugDump.arcs.push({direction:t,angle:s,renge:i})}dump(){const t={i:this.id,p:this.position.minimize(),d:this.direction,h:Math.ceil(this.shield),t:Math.ceil(this.temperature),a:this.missileAmmo,f:Math.ceil(this.fuel)};return this.scriptLoader&&this.scriptLoader.isDebuggable()&&(t.debug=this.debugDump),t}}const _=128;class F{constructor(t,s=!1){this.scriptLoaderConstructor=t,this.isDemo=s,this.currentId=0,this.center=0,this.isFinished=!1,this.dummyEnemy=new d(0,150),this.frame=0,this.sourcers=[],this.shots=[],this.fxs=[]}registerSourcer(t,s,i,e){const n=this.sourcers.length%2===0?-1:1,o=c.rand(80)+160*n,r=c.rand(160)+80;this.addSourcer(new O(this,o,r,t,s,i,e))}async process(t,s){for(const i of this.sourcers)t.onPreThink(i.id),await t.waitNextTick(),s(i),t.onPostThink(i.id),await t.waitNextTick()}async compile(t){return this.process(t,s=>{try{s.compile(new this.scriptLoaderConstructor)}catch(i){const e=i instanceof Error?i.message:String(i);t.onError(`There is an error in your code: ${e}`)}})}addSourcer(t){t.id=this.currentId++,this.sourcers.push(t)}addShot(t){t.id=this.currentId++,this.shots.push(t)}removeShot(t){const s=this.shots.indexOf(t);0<=s&&this.shots.splice(s,1)}addFx(t){t.id=this.currentId++,this.fxs.push(t)}removeFx(t){const s=this.fxs.indexOf(t);0<=s&&this.fxs.splice(s,1)}async tick(t){this.frame===0&&t.onFrame(this.dump()),this.center=this.computeCenter(),await this.process(t,s=>{s.think(),this.shots.filter(i=>i.owner.id===s.id).forEach(i=>i.think())}),this.sourcers.forEach(s=>s.action()),this.shots.forEach(s=>s.action()),this.fxs.forEach(s=>s.action()),this.sourcers.forEach(s=>s.move()),this.shots.forEach(s=>s.move()),this.fxs.forEach(s=>s.move()),this.checkFinish(t),this.checkEndOfGame(t),this.frame++,t.onFrame(this.dump())}checkFinish(t){if(this.isDemo){_<this.frame&&(this.result={frame:this.frame,timeout:null,isDraw:null,winnerId:null},t.onFinished(this.result));return}if(this.result)return;this.sourcers.forEach(i=>{i.alive=0<i.shield});const s=this.sourcers.filter(i=>i.alive);if(!(1<s.length)){if(s.length===1){const i=s[0];this.result={winnerId:i.id,frame:this.frame,timeout:null,isDraw:!1},t.onFinished(this.result);return}this.result={winnerId:null,timeout:null,frame:this.frame,isDraw:!0},t.onFinished(this.result)}}checkEndOfGame(t){if(!this.isFinished&&this.result){if(this.isDemo){this.isFinished=!0,t.onEndOfGame();return}this.result.frame<this.frame-90&&(this.isFinished=!0,t.onEndOfGame())}}scanEnemy(t,s){return this.isDemo&&this.sourcers.length===1?s(this.dummyEnemy):this.sourcers.some(i=>i.alive&&i!==t&&s(i.position))}scanAttack(t,s){return this.shots.some(i=>i.owner!==t&&s(i.position)&&this.isIncoming(t,i))}isIncoming(t,s){const i=t.position,e=s.position,n=i.distance(e);return i.distance(e.add(s.speed))<n}checkCollision(t){const s=t.position,i=t.position.add(t.speed),e=this.shots.find(o=>o.breakable&&o.owner!==t.owner&&c.calcDistance(s,i,o.position)<t.size+o.size);if(e)return e;const n=this.sourcers.find(o=>o.alive&&o!==t.owner&&c.calcDistance(s,i,o.position)<t.size+o.size);return n||null}checkCollisionEnviroment(t){return t.position.y<0}computeCenter(){let t=0,s=0;return this.sourcers.forEach(i=>{i.alive&&(s+=i.position.x,t++)}),s/t}players(){const t={};return this.sourcers.forEach(s=>{t[s.id]={name:s.name||s.account,account:s.account,color:s.color}}),t}dump(){const t=[],s=[],i=[];return this.sourcers.forEach(e=>{t.push(e.dump())}),this.shots.forEach(e=>{s.push(e.dump())}),this.fxs.forEach(e=>{i.push(e.dump())}),{f:this.frame,s:t,b:s,x:i}}}function R(a,t){function s(){return a.apply(this,t)}return s.prototype=a.prototype,new s}class k{constructor(){this.console={log:(...s)=>{}};const t={Object,String,Number,Boolean,Array,Date,Math,RegExp,JSON,NaN:NaN,Infinity:1/0,undefined:void 0,parseInt,parseFloat,isNaN,isFinite,console:this.console};this.argNames=Object.keys(t),this.argValues=this.argNames.map(s=>t[s])}isDebuggable(){return!0}getExposedConsole(){return this.console}load(t){let s=[];return s=s.concat(this.argNames),s.push(`"use strict";
`+t),R(Function,s).apply(void 0,this.argValues)}}let C=0;const P=()=>C++,g={};onmessage=({data:a})=>{if(a.issuedId!==void 0){g[a.issuedId](),delete g[a.issuedId];return}const t=a,s=t.isDemo,i=t.sources,e=[],n={waitNextTick:async()=>new Promise(r=>{const l=P();g[l]=r,postMessage({issuedId:l,command:"Next"})}),onPreThink:r=>{postMessage({command:"PreThink",id:r})},onPostThink:r=>{postMessage({command:"PostThink",id:r,loadedFrame:e.length})},onFrame:r=>{e.push(r)},onFinished:r=>{postMessage({result:r,command:"Finished"})},onEndOfGame:()=>{postMessage({frames:e,command:"EndOfGame"})},onError:r=>{postMessage({error:r,command:"Error"})}},o=new F(k,s);i.forEach(r=>{o.registerSourcer(r.source,r.name,r.name,r.color)}),postMessage({command:"Players",players:o.players()}),setTimeout(async()=>{await o.compile(n);for(let r=0;r<1e4&&!o.isFinished;r++)await o.tick(n)},0)};
//# sourceMappingURL=arenaWorker.js.map
